<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<meta property="og:title" content="2. Example usage" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://arm-software.github.io/psa-api/fwu/1.0/appendix/examples.html" />
<link rel="canonical" href="https://arm-software.github.io/psa-api/fwu/1.0/appendix/examples.html" />
<meta property="og:site_name" content="PSA Certified Firmware Update API 1.0" />
<meta property="og:description" content="Retrieve versions of installed images: This example shows the retrieval of image versions for all components. Individual component update (single part operation): This example shows the installatio..." />
<meta name="description" content="Retrieve versions of installed images: This example shows the retrieval of image versions for all components. Individual component update (single part operation): This example shows the installatio..." />

    <title>2. Example usage &#8212; PSA Certified Firmware Update API 1.0</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="preconnect" type="text/css" href="https://fonts.googleapis.com" />
    <link rel="preconnect" type="text/css" href="https://fonts.gstatic.com" />
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,400;0,700;1,400&display=swap" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="3. Variation in system design parameters" href="variations.html" />
    <link rel="prev" title="1. Example header file" href="example-header.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="example-usage">
<span id="examples"></span><h1><span class="section-number">B. </span>Example usage<a class="headerlink" href="#example-usage" title="Permalink to this heading">¶</a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>These examples are for illustrative purposes only and are not guaranteed to compile. Many error codes are not handled in order to keep the examples brief. A real implementation will need to initialize variables appropriately and handle failures as they see fit.</p>
</div>
<section id="retrieve-versions-of-installed-images">
<h2><span class="section-number">B.1. </span>Retrieve versions of installed images<a class="headerlink" href="#retrieve-versions-of-installed-images" title="Permalink to this heading">¶</a></h2>
<p>This example shows the retrieval of image versions for all components.</p>
<pre class="literal-block"> 1   #include &lt;psa/update.h&gt;
 2   
 3   <em>/* Assume that the components in this system have sequential identifiers
 4    * starting at zero.
 5    */</em>
 6   #define NUM_COMPONENTS 3
 7   
 8   void example_get_installation_info() {
 9   
10       psa_status_t rc;
11       <a class="reference internal" href="../api/api.html#c.psa_fwu_component_t" title="psa_fwu_component_t">psa_fwu_component_t</a> id;
12       <a class="reference internal" href="../api/api.html#c.psa_fwu_component_info_t" title="psa_fwu_component_info_t">psa_fwu_component_info_t</a> info;
13   
14       for (id = 0; id &lt; NUM_COMPONENTS; ++id) {
15           rc = <a class="reference internal" href="../api/api.html#c.psa_fwu_query" title="psa_fwu_query">psa_fwu_query</a>(id, &amp;info);
16   
17           if (rc == PSA_SUCCESS) {
18               specific_protocol_report(id, info.version);
19           }
20       }
21   }</pre>
</section>
<section id="individual-component-update-single-part-operation">
<h2><span class="section-number">B.2. </span>Individual component update (single part operation)<a class="headerlink" href="#individual-component-update-single-part-operation" title="Permalink to this heading">¶</a></h2>
<p>This example shows the installation of a single component that is smaller than <a class="reference internal" href="../api/api.html#c.PSA_FWU_MAX_WRITE_SIZE" title="PSA_FWU_MAX_WRITE_SIZE"><code class="xref any atg_c atg_c-ref docutils literal notranslate"><span class="pre">PSA_FWU_MAX_WRITE_SIZE</span></code></a>.</p>
<pre class="literal-block"> 1   #include &lt;psa/update.h&gt;
 2   
 3   <em>/* Simple, single image update with a bundled manifest.
 4    * Component requires reboot
 5    */</em>
 6   
 7   void example_install_single_image(<a class="reference internal" href="../api/api.html#c.psa_fwu_component_t" title="psa_fwu_component_t">psa_fwu_component_t</a> id,
 8                                     const void *image, size_t image_size) {
 9       psa_status_t rc;
10   
11       <em>// Assume the component state is READY</em>
12       rc = <a class="reference internal" href="../api/api.html#c.psa_fwu_start" title="psa_fwu_start">psa_fwu_start</a>(id, NULL, 0);
13   
14       if (rc == PSA_SUCCESS) {
15           rc = <a class="reference internal" href="../api/api.html#c.psa_fwu_write" title="psa_fwu_write">psa_fwu_write</a>(id, 0, image, image_size);
16   
17           if (rc == PSA_SUCCESS) {
18               rc = <a class="reference internal" href="../api/api.html#c.psa_fwu_finish" title="psa_fwu_finish">psa_fwu_finish</a>(id);
19   
20               if (rc == PSA_SUCCESS) {
21                   rc = <a class="reference internal" href="../api/api.html#c.psa_fwu_install" title="psa_fwu_install">psa_fwu_install</a>();
22   
23                   if (rc == <a class="reference internal" href="../api/api.html#c.PSA_SUCCESS_REBOOT" title="PSA_SUCCESS_REBOOT">PSA_SUCCESS_REBOOT</a>) {
24                       <em>// do other things and then eventually...</em>
25                       <a class="reference internal" href="../api/api.html#c.psa_fwu_request_reboot" title="psa_fwu_request_reboot">psa_fwu_request_reboot</a>();
26                       return;     <em>// or wait for reboot to happen</em>
27                   }
28               }
29           }
30           <em>// an error occurred during image preparation: clean up</em>
31           <a class="reference internal" href="../api/api.html#c.psa_fwu_cancel" title="psa_fwu_cancel">psa_fwu_cancel</a>(id);
32           <a class="reference internal" href="../api/api.html#c.psa_fwu_clean" title="psa_fwu_clean">psa_fwu_clean</a>(id);
33       }
34       <em>// report failure...</em>
35   }</pre>
</section>
<section id="individual-component-update-multi-part-operation">
<span id="example-multi-write"></span><h2><span class="section-number">B.3. </span>Individual component update (multi part operation)<a class="headerlink" href="#individual-component-update-multi-part-operation" title="Permalink to this heading">¶</a></h2>
<p>This example shows the installation of a component that can be larger than <a class="reference internal" href="../api/api.html#c.PSA_FWU_MAX_WRITE_SIZE" title="PSA_FWU_MAX_WRITE_SIZE"><code class="xref any atg_c atg_c-ref docutils literal notranslate"><span class="pre">PSA_FWU_MAX_WRITE_SIZE</span></code></a>, and requires writing in multiple blocks.</p>
<pre class="literal-block"> 1   #include &lt;psa/update.h&gt;
 2   #include &lt;stdlib.h&gt;
 3   #include &lt;stddef.h&gt;
 4   
 5   <em>/* Single image update with a bundled manifest.
 6    * Image data is fetched and written incrementally in blocks
 7    */</em>
 8   
 9   void example_install_single_image_multipart(<a class="reference internal" href="../api/api.html#c.psa_fwu_component_t" title="psa_fwu_component_t">psa_fwu_component_t</a> id,
10                                               size_t total_image_size) {
11       psa_status_t rc;
12       size_t offset;
13       size_t to_send;
14       void *image;
15   
16       <em>// Assume the component state is READY</em>
17       rc = <a class="reference internal" href="../api/api.html#c.psa_fwu_start" title="psa_fwu_start">psa_fwu_start</a>(id, NULL, 0);
18   
19       if (rc == PSA_SUCCESS) {
20           <em>// Using dynamically allocated memory for this example</em>
21   
22           image = malloc(<a class="reference internal" href="../api/api.html#c.PSA_FWU_MAX_WRITE_SIZE" title="PSA_FWU_MAX_WRITE_SIZE">PSA_FWU_MAX_WRITE_SIZE</a>);
23           if (image == NULL) {
24               rc == PSA_ERROR_INSUFFICIENT_MEMORY;
25           } else {
26               for (offset = 0;
27                   offset &lt; total_image_size,
28                   offset += <a class="reference internal" href="../api/api.html#c.PSA_FWU_MAX_WRITE_SIZE" title="PSA_FWU_MAX_WRITE_SIZE">PSA_FWU_MAX_WRITE_SIZE</a>) {
29                   to_send = min(<a class="reference internal" href="../api/api.html#c.PSA_FWU_MAX_WRITE_SIZE" title="PSA_FWU_MAX_WRITE_SIZE">PSA_FWU_MAX_WRITE_SIZE</a>, total_image_size - offset);
30                   if (fetch_next_part_of_image(id, image, to_send)) {
31                       <em>// failed to obtain next block of image</em>
32                       rc == PSA_ERROR_GENERIC_ERROR;
33                       break;
34                   } else {
35                       rc = <a class="reference internal" href="../api/api.html#c.psa_fwu_write" title="psa_fwu_write">psa_fwu_write</a>(id, offset, image, to_send);
36                       if (rc != PSA_SUCCESS) {
37                           break;
38                       }
39                   }
40               }
41               free(image);
42           }
43   
44           if (rc == PSA_SUCCESS) {
45               rc = <a class="reference internal" href="../api/api.html#c.psa_fwu_finish" title="psa_fwu_finish">psa_fwu_finish</a>(id);
46   
47               if (rc == PSA_SUCCESS) {
48                   rc = <a class="reference internal" href="../api/api.html#c.psa_fwu_install" title="psa_fwu_install">psa_fwu_install</a>();
49   
50                   if (rc == PSA_SUCCESS) {
51                       <em>// installation completed, now clean up</em>
52                       <a class="reference internal" href="../api/api.html#c.psa_fwu_clean" title="psa_fwu_clean">psa_fwu_clean</a>(id);
53                       <em>// report success ...</em>
54                       return;
55                   } else if (rc == <a class="reference internal" href="../api/api.html#c.PSA_SUCCESS_REBOOT" title="PSA_SUCCESS_REBOOT">PSA_SUCCESS_REBOOT</a>) {
56                       <em>// do other things and then eventually...</em>
57                       <a class="reference internal" href="../api/api.html#c.psa_fwu_request_reboot" title="psa_fwu_request_reboot">psa_fwu_request_reboot</a>();
58                       return;     <em>// or wait for reboot to happen</em>
59                   }
60               }
61           }
62           <em>// an error occurred during image preparation: clean up</em>
63           <a class="reference internal" href="../api/api.html#c.psa_fwu_cancel" title="psa_fwu_cancel">psa_fwu_cancel</a>(id);
64           <a class="reference internal" href="../api/api.html#c.psa_fwu_clean" title="psa_fwu_clean">psa_fwu_clean</a>(id);
65       }
66       <em>// report failure...</em>
67   }</pre>
</section>
<section id="multiple-components-with-dependent-images">
<span id="multi-component-example"></span><h2><span class="section-number">B.4. </span>Multiple components with dependent images<a class="headerlink" href="#multiple-components-with-dependent-images" title="Permalink to this heading">¶</a></h2>
<p>This example shows how multiple components can be installed together. This is required if the images are inter-dependent, and it is not possible to install them in sequence because of the dependencies.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Not all implementations that have multiple components support this type of multi-component update.</p>
</div>
<pre class="literal-block"> 1   #include &lt;psa/update.h&gt;
 2   
 3   <em>/* Atomic, multiple image update, with bundled manifests.
 4    * Installation requires reboot
 5    */</em>
 6   
 7   <em>// Prepare a single image for update</em>
 8   static psa_status_t prepare_image(<a class="reference internal" href="../api/api.html#c.psa_fwu_component_t" title="psa_fwu_component_t">psa_fwu_component_t</a> id,
 9                              const void *image, size_t image_size) {
10       psa_status_t rc;
11   
12       <em>// Assume the component state is READY</em>
13       rc = <a class="reference internal" href="../api/api.html#c.psa_fwu_start" title="psa_fwu_start">psa_fwu_start</a>(id, NULL, 0);
14   
15       if (rc == PSA_SUCCESS) {
16           rc = <a class="reference internal" href="../api/api.html#c.psa_fwu_write" title="psa_fwu_write">psa_fwu_write</a>(id, 0, image, image_size);
17   
18           if (rc == PSA_SUCCESS) {
19               rc = <a class="reference internal" href="../api/api.html#c.psa_fwu_finish" title="psa_fwu_finish">psa_fwu_finish</a>(id);
20   
21           if (rc != PSA_SUCCESS) {
22               <em>// an error occurred during image preparation: clean up</em>
23               <a class="reference internal" href="../api/api.html#c.psa_fwu_cancel" title="psa_fwu_cancel">psa_fwu_cancel</a>(id);
24               <a class="reference internal" href="../api/api.html#c.psa_fwu_clean" title="psa_fwu_clean">psa_fwu_clean</a>(id);
25           }
26       }
27       return rc;
28   }
29   
30   <em>// Fetch and prepare a single image for update</em>
31   static psa_status_t fetch_and_prepare_image(<a class="reference internal" href="../api/api.html#c.psa_fwu_component_t" title="psa_fwu_component_t">psa_fwu_component_t</a> id) {
32       psa_status_t rc;
33       void *image;
34       size_t image_size;
35   
36       <em>// Get image data.</em>
37       <em>// Assume this is dynamically allocated memory in this example</em>
38       image = fetch_image_data(id, &amp;image_size);
39       if (image == NULL)
40           return PSA_ERROR_INSUFFICIENT_MEMORY;
41   
42       rc = prepare_image(id, image, image_size);
43       free(image);
44       return rc;
45   }
46   
47   <em>// Update a set of components atomically</em>
48   <em>// Prepare all the images before installing</em>
49   <em>// Clean up all preparation on error</em>
50   void example_install_multiple_images(psa_fwu_component_id ids[],
51                                        size_t num_ids) {
52       psa_status_t rc;
53       int ix;
54   
55       for (ix = 0, ix &lt; num_ids; ++ix) {
56           rc = fetch_and_prepare_image(ids[ix]);
57           if (rc != PSA_SUCCESS)
58               break;
59       }
60   
61       if (rc == PSA_SUCCESS) {
62           <em>// All images are prepared, so now install them</em>
63           rc = <a class="reference internal" href="../api/api.html#c.psa_fwu_install" title="psa_fwu_install">psa_fwu_install</a>();
64   
65           if (rc == <a class="reference internal" href="../api/api.html#c.PSA_SUCCESS_REBOOT" title="PSA_SUCCESS_REBOOT">PSA_SUCCESS_REBOOT</a>) {
66               <em>// do other things and then eventually...</em>
67               <a class="reference internal" href="../api/api.html#c.psa_fwu_request_reboot" title="psa_fwu_request_reboot">psa_fwu_request_reboot</a>();
68               return;     <em>// or wait for reboot to happen</em>
69           }
70       }
71       <em>// an error occurred during image preparation: clean up.</em>
72       <em>// All of the components prior to element ix have been prepared</em>
73       <em>// Update of these needs to be aborted and erased.</em>
74       while (--ix &gt;= 0) {
75           <a class="reference internal" href="../api/api.html#c.psa_fwu_cancel" title="psa_fwu_cancel">psa_fwu_cancel</a>(ids[ix]);
76           <a class="reference internal" href="../api/api.html#c.psa_fwu_clean" title="psa_fwu_clean">psa_fwu_clean</a>(ids[ix]);
77       }
78       <em>// Report the failure ...</em>
79   }</pre>
</section>
<section id="clean-up-all-component-updates">
<h2><span class="section-number">B.5. </span>Clean up all component updates<a class="headerlink" href="#clean-up-all-component-updates" title="Permalink to this heading">¶</a></h2>
<p>This example removes any prepared and failed update images for all components.</p>
<pre class="literal-block"> 1   #include &lt;psa/update.h&gt;
 2   
 3   <em>/* Assume that the components in this system have sequential identifiers
 4    * starting at zero.
 5    */</em>
 6   #define NUM_COMPONENTS 3
 7   
 8   <em>/* Forcibly cancel and clean up all components to return to READY state */</em>
 9   
10   void example_clean_all_components() {
11   
12       psa_status_t rc;
13       <a class="reference internal" href="../api/api.html#c.psa_fwu_component_t" title="psa_fwu_component_t">psa_fwu_component_t</a> id;
14       <a class="reference internal" href="../api/api.html#c.psa_fwu_component_info_t" title="psa_fwu_component_info_t">psa_fwu_component_info_t</a> info;
15   
16       rc = <a class="reference internal" href="../api/api.html#c.psa_fwu_reject" title="psa_fwu_reject">psa_fwu_reject</a>();
17       if (rc == <a class="reference internal" href="../api/api.html#c.PSA_SUCCESS_REBOOT" title="PSA_SUCCESS_REBOOT">PSA_SUCCESS_REBOOT</a>) {
18           <a class="reference internal" href="../api/api.html#c.psa_fwu_request_reboot" title="psa_fwu_request_reboot">psa_fwu_request_reboot</a>();
19           <em>// After reboot, run this function again to finish clean up</em>
20           return;
21       }
22   
23       for (id = 0; id &lt; NUM_COMPONENTS; ++id) {
24           rc = <a class="reference internal" href="../api/api.html#c.psa_fwu_query" title="psa_fwu_query">psa_fwu_query</a>(id, &amp;info);
25   
26           if (rc == PSA_SUCCESS) {
27               switch (info.state) {
28                  case <a class="reference internal" href="../api/api.html#c.PSA_FWU_WRITING" title="PSA_FWU_WRITING">PSA_FWU_WRITING</a>:
29                  case <a class="reference internal" href="../api/api.html#c.PSA_FWU_CANDIDATE" title="PSA_FWU_CANDIDATE">PSA_FWU_CANDIDATE</a>:
30                     <a class="reference internal" href="../api/api.html#c.psa_fwu_cancel" title="psa_fwu_cancel">psa_fwu_cancel</a>(id);
31                     <a class="reference internal" href="../api/api.html#c.psa_fwu_clean" title="psa_fwu_clean">psa_fwu_clean</a>(id);
32                     break;
33                  case <a class="reference internal" href="../api/api.html#c.PSA_FWU_FAILED" title="PSA_FWU_FAILED">PSA_FWU_FAILED</a>:
34                  case <a class="reference internal" href="../api/api.html#c.PSA_FWU_UPDATED" title="PSA_FWU_UPDATED">PSA_FWU_UPDATED</a>:
35                     <a class="reference internal" href="../api/api.html#c.psa_fwu_clean" title="psa_fwu_clean">psa_fwu_clean</a>(id);
36                     break;
37               }
38           }
39       }
40   }</pre>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/Arm_logo_blue_RGB.svg" alt="Logo"/>
            </a></p><hr />
<h3><a href="../index.html"><b>PSA Certified<br />Firmware Update API</b></a></h3>
IHI 0093<br/>
Non-confidential<br/>
Version 1.0.0
<hr />
<ul>
<li class="toctree-l1"><a class="reference internal" href="../about.html">About this document</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../overview/intro.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/goals.html">2. Design goals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/architecture.html">3. Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/programming-model.html">4. Programming model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/api.html">5. API reference</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="example-header.html">A. Example header file</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">B. Example usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#retrieve-versions-of-installed-images">B.1. Retrieve versions of installed images</a></li>
<li class="toctree-l2"><a class="reference internal" href="#individual-component-update-single-part-operation">B.2. Individual component update (single part operation)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#individual-component-update-multi-part-operation">B.3. Individual component update (multi part operation)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#multiple-components-with-dependent-images">B.4. Multiple components with dependent images</a></li>
<li class="toctree-l2"><a class="reference internal" href="#clean-up-all-component-updates">B.5. Clean up all component updates</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="variations.html">C. Variation in system design parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="sra.html">D. Security Risk Assessment</a></li>
<li class="toctree-l1"><a class="reference internal" href="change-history.html">E. Document change history</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../atg_c-identifiers.html">Index of API elements</a></li>
</ul>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy; 2020-2023 Arm Limited and/or its affiliates.
      
    </div>

    

    
  </body>
</html>